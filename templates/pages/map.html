{% load static %}

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""></script>

<div id="mapid" class="mx-auto mt-4"></div>

<script>
  // icons
  var greenIcon = L.icon({
    iconUrl: '/static/images/pin_green.svg',
    shadowUrl: '',
    iconSize: [38, 95], // size of the icon
    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
  });

  var redIcon = L.icon({
    iconUrl: '/static/images/pin_red.svg',
    shadowUrl: '',
    iconSize: [38, 95], // size of the icon
    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
  });

  var greenQuestion = L.icon({
    iconUrl: '/static/images/question_green.svg',
    shadowUrl: '',
    iconSize: [38, 95], // size of the icon
    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
  });

  var redQuestion = L.icon({
    iconUrl: '/static/images/question_red.svg',
    shadowUrl: '',
    iconSize: [38, 95], // size of the icon
    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
  });

  // get locations and convert it to floats
  var center_lon = "{{ longitude }}"
  var center_lat = "{{ latitude }}"
  if (isNaN(parseFloat(center_lon))) {
    center_lon = 10
  } else {
    center_lon = parseFloat(center_lon)
  }

  if (isNaN(parseFloat(center_lat))) {
    center_lat = 52
  } else {
    center_lat = parseFloat(center_lat)
  }

  // prepare the map
  var mymap = L.map('mapid').setView([center_lat, center_lon], 10);

  L.tileLayer(
    'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidGVocGhpbGIiLCJhIjoiY2s3emFtN2M4MDNwajNxb2ducGNuNWk4byJ9.MxBMpm6g_oaptJPqgqmG7g', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1,
      accessToken: 'pk.eyJ1IjoidGVocGhpbGIiLCJhIjoiY2s3emFtN2M4MDNwajNxb2ducGNuNWk4byJ9.MxBMpm6g_oaptJPqgqmG7g'
    }).addTo(mymap);

  // get further information to plot
  var group_membership = '{{ group_membership }}'
  group_membership = group_membership.replace('[', '').replace(']', '').split(',')

  var slogan = '{{ slogan }}'
  slogan = slogan.replace('[', '').replace(']', '').replace(/[&]/g, '').replace(/[#]/g, '').replace(/[0-9]/g, '')
    .replace(/[;]/g, '').split(',')

  var description = '{{ description }}'
  description = description.replace('[', '').replace(']', '').replace(/[&]/g, '').replace(/[#]/g, '').replace(/[0-9]/g,
    '').replace(/[;]/g, '').split(',')

  var ids = '{{ id }}'
  ids = ids.replace('[', '').replace(']', '').split(',')
  // Longitudes
  var longitudes = '{{ longitudes }}'
  longitudes = longitudes.replace('[', '').replace(']', '').replace(' ', '').split(',')
  var sum = 0;
  for(var i=0; i<longitudes.length;i++) {
    longitudes[i] = parseFloat(longitudes[i]);
    sum += longitudes[i]
  }
  var long_mean = sum / longitudes.length;
  
  
  // Latitudes
  var latitudes = '{{ latitudes }}'
  latitudes = latitudes.replace('[', '').replace(']', '').replace(' ', '').split(',')
  var sum = 0;
  for(var i=0; i<latitudes.length;i++) {
    latitudes[i] = parseFloat(latitudes[i]);
    sum += latitudes[i]
  }
  
  var lat_mean = sum / latitudes.length;
  var longitude_center = '{{ longitude }}'
  var latitude_center = '{{ latitude }}'
  
  longitude_center = parseFloat(longitude_center.replace(',', '.'))
  latitude_center = parseFloat(latitude_center.replace(',', '.'))
  console.log(longitude_center)

  var map_show_location = '{{ map_show_location }}'
  map_show_location = map_show_location.replace('[', '').replace(']', '').replace(/ /g, '').split(',')

  var is_authenticated = '{{ user.is_authenticated }}'
  var contact_link
  
  
  // iterate through all filtered results  
  var i;
  for (i = 0; i < longitudes.length; i++) {
    lon_i = longitudes[i]
    lat_i = latitudes[i]
    slogan_i = slogan[i].replace('x', '')
    //slogan_i = slogan_i.slice(1, -1);
    description_i = description[i].replace('x', '')
    //description_i = description_i.slice(1, -1);
    id_i = ids[i].replace(/ /g, '')


    // show contact link or not
    if (is_authenticated == 'True') {
      contact_link = "<br><a href='http://127.0.0.1:8000/mailme/" + id_i + "'>Mail me</a>"
    }
    if (is_authenticated == 'False') {
      contact_link = "<br><b>Please register to contact the user.</b>"
    }

    // select the right icon

    // provide help & rough location --> red question mark
    if (group_membership[i] == 0 && map_show_location[i] == '0') {
      var icon = greenQuestion;
    }
    // provide help & exact location --> red marker
    if (group_membership[i] == 0 && map_show_location[i] == '1') {
      var icon = greenIcon;
    }
    // need help & rough location --> green question mark
    if (group_membership[i] == 1 && map_show_location[i] == '0') {
      var icon = redQuestion;
    }
    // need help & exact location --> green marker
    if (group_membership[i] == 1 && map_show_location[i] == '1') {
      var icon = redIcon;
    }
    //var icon = greenQuestion

    L.marker([lat_i, lon_i], {
      icon: icon
    }).addTo(mymap).bindPopup("<b><font color='red'><center>" + i + " </center></font><br>" + slogan_i +
      "</b><br><i>" + description_i + "</i>" + contact_link, {closeOnClick: false, autoClose: true}).openPopup();

  }
  // Create a center circle
  console.log(longitude_center)
  console.log(latitude_center)
L.circle([latitude_center, longitude_center], {color: 'green', fillColor: 'green', fillOpacity: 0.1, radius: 20000, stroke: false, bubblingMouseEvents: false}).addTo(mymap);

  //L.marker([53.554434, 9.994125]).addTo(mymap).bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
  /* var marker = L.marker([53.554434, 9.994125]).addTo(mymap);

  var circle = L.circle([53.554434, 9.994125], {
    color: 'red',
    fillColor: '#f03',
    fillOpacity: 0.3,
    radius: 100
    }).addTo(mymap);
  
  marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();

  var popup = L.popup();  */

  /* function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
    }
    mymap.on('click', onMapClick); */
</script>
<div class="container results-table">
  <table class="table">
    <tr>
      <th>Result</th>
      <th>Slogan</th>
      <th>Description</th>
      <th>Contact</th>
    </tr>
    {% for item in template_table %}
    <tr>
      <td>{{ item.0 }}</td>
      <td>{{ item.2 }}</td>
      <td>{{ item.3 }}</td>
      <td><button type="button" class="btn btn-secondary rounded-0"
          onclick="location.href='http://127.0.0.1:8000/mailme/{{item.1 }}'">Mail me</button></td>
    </tr>
    {% endfor %}

  </table>
</div>